name: Parent Workflow

on:
  pull_request:
  push:
    branches:
      - develop
      - main

permissions:
  contents: write
  pages: write
  pull-requests: write
  id-token: write

jobs:
  child_workflows:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [labeler, check_amalgamation, test_trudag_extensions]
    steps:
      - name: Run child workflows
        run: echo "${{ matrix.target }}"



  collect-and-deploy:
    name: "Collect Results & Deploy"
    needs: [child_workflows]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check child workflow results
        run: |
          echo "=== Child Workflow Results ==="
          for job in labeler check_amalgamation test_trudag_extensions; do
            result="${{ needs.child_workflows.outputs['${job}'] }}"
            echo "$job workflow: $result"
            if [[ "$result" != "success" ]]; then
              echo "âŒ $job failed"
              exit 1
            fi
          done
          echo "âœ… All workflows succeeded"
      - name: Download Artifacts
        run: |
          mkdir -p artifacts/
          for job in labeler check_amalgamation test_trudag_extensions; do
            echo "Downloading artifact for $job"
            gh run download --name "${job}-${GITHUB_SHA}" --dir artifacts/
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create deployment package
        run: |
          mkdir -p deployment
          echo "Deployment ready - $(date)" > deployment/deployment-info.txt
          cp -r artifacts/* deployment/
      - name: Upload final deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: "deployment-package-${{ github.sha }}"
          path: deployment/

      - name: Deployment simulation
        run: |
          echo "ðŸš€ Simulating deployment..."
          sleep 2
          echo "âœ… Deployment completed successfully!"