name: Parent Workflow

on:
  pull_request:
  push:
    branches:
      - develop
      - main

permissions:
  contents: write
  pages: write
  pull-requests: write
  id-token: write

jobs:
  trigger-and-deploy:
    name: Trigger and Deploy All Workflows
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Define Workflows
        id: define-workflows
        run: |
          echo "::set-output name=workflows::$(cat <<EOF
          [
            {"name": "labeler", "file": "labeler.yml"},
            {"name": "check_amalgamation", "file": "check_amalgamation.yml"},
            {"name": "test_trudag_extensions", "file": "test_trudag_extensions.yml"}
          ]
          EOF
          )"

      - name: Trigger Workflows Dynamically
        id: trigger
        run: |
          workflows='${{ steps.define-workflows.outputs.workflows }}'
          echo "$workflows" | jq -c '.[]' | while read -r workflow; do
            NAME=$(echo "$workflow" | jq -r '.name')
            FILE=$(echo "$workflow" | jq -r '.file')
            ARTIFACT_ID="${NAME}-${GITHUB_SHA}"

            echo "Triggering workflow: $NAME from file: $FILE with artifact ID: $ARTIFACT_ID"
            gh workflow run "./.github/workflows/$FILE" -F artifact_id="${ARTIFACT_ID}" || exit 1
          done

      - name: Wait for Workflows to Complete
        run: |
          echo "Waiting for workflows to complete..."
          sleep 20 # Optional step to wait or add smarter polling based on workflow state

      - name: Download All Workflow Artifacts
        run: |
          workflows='${{ steps.define-workflows.outputs.workflows }}'
          echo "$workflows" | jq -c '.[]' | while read -r workflow; do
            NAME=$(echo "$workflow" | jq -r '.name')
            ARTIFACT_ID="${NAME}-${GITHUB_SHA}"

            echo "Downloading artifact for workflow: $NAME (Artifact ID: $ARTIFACT_ID)"
            mkdir -p artifacts/$NAME
            gh run download --name "$ARTIFACT_ID" --dir "artifacts/$NAME" || echo "⚠️ No artifacts for $NAME"
          done

      - name: Create Deployment Package
        run: |
          echo "Creating deployment package..."
          mkdir -p deployment
          echo "Deployment ready - $(date)" > deployment/deployment-info.txt

          # Copy all artifacts to deployment folder
          if [[ -d artifacts ]]; then
            cp -r artifacts/* deployment/
          fi

      - name: Upload Final Deployment Package
        uses: actions/upload-artifact@v4
        with:
          name: "deployment-package-${{ github.sha }}"
          path: deployment/

      - name: Deployment Simulation
        run: |
          echo "🚀 Simulating deployment..."
          sleep 2
          echo "✅ Deployment completed successfully!"
