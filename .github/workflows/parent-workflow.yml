name: Parent Workflow

on: 
  pull_request:
  push:
    branches:
      - develop
      - main

permissions:
  contents: write
  pages: write
  pull-requests: write
  id-token: write

env:
  WORKFLOWS: |
    [
      {"name": "labeler", "file": "labeler.yml"},
      {"name": "check_amalgamation", "file": "check_amalgamation.yml"},
      {"name": "test_trudag_extensions", "file": "test_trudag_extensions.yml"}
    ]

jobs:
  trigger-and-collect:
    name: Trigger All Workflows
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workflow: ${{ fromJson(env.WORKFLOWS) }}

    steps:
      - name: Trigger Child Workflow - ${{ matrix.workflow.name }}
        uses: ./.github/workflows/${{ matrix.workflow.file }}
        with:
          artifact_id: "${{ matrix.workflow.name }}-${{ github.sha }}"
    
  collect-and-deploy:
    name: Collect Results & Deploy
    needs: trigger-and-collect
    runs-on: ubuntu-latest
    if: always() # Run even if some jobs fail

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download All Workflow Artifacts
        run: |
          WORKFLOWS='${{ env.WORKFLOWS }}'
          for WORKFLOW in $(echo "$WORKFLOWS" | jq -cr '.[] | @base64'); do
            _jq() {
              echo "$WORKFLOW" | base64 --decode | jq -r "${1}"
            }
            NAME=$(_jq '.name')
            ARTIFACT_ID="${NAME}-${{ github.sha }}"

            echo "Downloading artifact for workflow: $NAME"
            mkdir -p artifacts/$NAME
            gh run download --name "$ARTIFACT_ID" --dir "artifacts/$NAME" || echo "⚠️ No artifacts for $NAME"
          done

      - name: Create Deployment Package
        run: |
          echo "Creating deployment package..."
          mkdir -p deployment
          echo "Deployment ready - $(date)" > deployment/deployment-info.txt
          
          # Copy all artifacts to deployment folder
          if [[ -d artifacts ]]; then
            cp -r artifacts/* deployment/
          fi

      - name: Upload Deployment Package
        uses: actions/upload-artifact@v4
        with:
          name: "deployment-package-${{ github.sha }}"
          path: deployment/

      - name: Deployment Simulation
        run: |
          echo "🚀 Simulating deployment..."
          sleep 2
          echo "✅ Deployment completed successfully!"
